import { prisma } from "@/lib/prisma"; import { auth } from "@/lib/auth"; export async function POST(req:Request){ const session=await auth(); if(!session) return new Response("Unauthorized",{status:401}); const {barberId,serviceId,startISO}=await req.json(); const service=await prisma.service.findUnique({where:{id:Number(serviceId)}}); if(!service) return new Response("Service not found",{status:404}); const start=new Date(startISO); const end=new Date(start.getTime()+(service.durationMin+service.bufferMin)*60000); const overlap=await prisma.appointment.findFirst({where:{barberId:Number(barberId),start:{lt:end},end:{gt:start},status:{in:['BOOKED','DONE']}}}); if(overlap) return new Response("Horario indisponivel",{status:409}); const appt=await prisma.appointment.create({data:{customerId:Number((session as any).user?.id||0),barberId:Number(barberId),serviceId:Number(serviceId),start,end,status:'BOOKED'}}); return Response.json(appt);}